<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Happy Valentineâ€™s Day </title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    body{font-family:"Press Start 2P",system-ui}
    .wrap{position:relative;width:100vw;height:100vh}
    canvas{width:100%;height:100%;display:block;image-rendering:pixelated}
    .btn{
      position:absolute; right:14px; bottom:120px;
      background:rgba(0,0,0,.35);
      border:2px solid rgba(255,255,255,.18);
      border-radius:14px; padding:10px;
      backdrop-filter: blur(6px);
    }
    button{
      font-family:"Press Start 2P";
      font-size:10px;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #000;
      background:#fff2fb;
      color:#000;
      box-shadow:2px 2px 0 #000;
      cursor:pointer;
    }
    button:active{transform:translate(1px,1px);box-shadow:1px 1px 0 #000}
  </style>
</head>
<body>
<div class="wrap">
  <canvas id="c"></canvas>

  <div class="btn">
    <button id="muteBtn">Mute</button>
  </div>

  <!-- ONLY Sofia mp3 -->
  <audio id="bgm" loop preload="auto">
    <source src="AUD-20210820-WA0076.mp3" type="audio/mpeg">
  </audio>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // ===== Virtual game screen (always fits iPhone) =====
  const VW = 360, VH = 640;
  let scale = 1, offX = 0, offY = 0;

  function resize(){
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);

    scale = Math.min(window.innerWidth / VW, window.innerHeight / VH);
    offX = (window.innerWidth  - VW * scale) / 2;
    offY = (window.innerHeight - VH * scale) / 2;
  }
  window.addEventListener("resize", resize);
  resize();

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  function toGameCoords(clientX, clientY){
    const rect = canvas.getBoundingClientRect();
    let x = (clientX - rect.left - offX) / scale;
    let y = (clientY - rect.top  - offY) / scale;
    x = clamp(x, 0, VW);
    y = clamp(y, 0, VH);
    return { x, y };
  }

  // ===== Audio =====
  const bgm = document.getElementById("bgm");
  let muted = false;
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  const safeResumeAudio = ()=>{ if(AC.state==="suspended") AC.resume(); };

  function chime(){
    if(muted) return;
    const now = AC.currentTime;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type="triangle";
    o.frequency.setValueAtTime(760, now);
    o.frequency.exponentialRampToValueAtTime(1120, now+0.09);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
    o.connect(g).connect(AC.destination);
    o.start(now); o.stop(now+0.18);
  }

  async function tryPlaySofia(){
    try { bgm.muted = muted; await bgm.play(); } catch(e) {}
  }

  document.getElementById("muteBtn").onclick = () => {
    muted = !muted;
    bgm.muted = muted;
    document.getElementById("muteBtn").textContent = muted ? "Unmute" : "Mute";
    chime();
  };

  // ===== Layout =====
  const GROUND_Y = 260;
  const sigText = "I love you, Dimi â€” from Bas ðŸ’—";

  // ===== Messages (20) =====
  const messages = [
    "I'm so proud of you.",
    "You are my sunshine.",
    "You are the best girlfriend.",
    "You make my days brighter.",
    "I believe in you always.",
    "You are so strong.",
    "You are so kind.",
    "You inspire me every day.",
    "I love your smile so much.",
    "I choose you, again and again.",
    "You mean the world to me.",
    "You are my favorite person.",
    "You make my heart feel calm.",
    "I'm grateful for you every day.",
    "You deserve all good things.",
    "Your laugh is my favorite sound.",
    "Being with you feels like home.",
    "You are more than enough.",
    "I adore everything about you.",
    "Forever and always, my bby ðŸ’—"
  ];
  let msgIndex = 0;

  let bubbleText = "Tap anywhere to drop cheese ðŸ§€";
  let bubbleTimer = 220;
  let sparkleTimer = 0;

  function showBubble(t){
    bubbleText = t;
    bubbleTimer = 260;
    sparkleTimer = 80;
  }

  // ===== Helpers =====
  function roundRect(x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    fill ? ctx.fill() : ctx.stroke();
  }

  function wrapLines(text, maxWidth){
    const words = text.split(" ");
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      if(ctx.measureText(test).width <= maxWidth) line = test;
      else { if(line) lines.push(line); line = w; }
    }
    if(line) lines.push(line);
    return lines.slice(0, 3);
  }

  function drawBubbleMiddleSky(){
    const skyTop = 125;
    const skyBottom = GROUND_Y - 18;
    const midY = (skyTop + skyBottom) / 2;

    const bw = VW - 60;
    const bx = (VW - bw) / 2;

    ctx.font="11px 'Press Start 2P'";
    const lines = wrapLines(bubbleText, bw - 28);
    const lineH = 16;
    const bh = 22 + lines.length * lineH;
    const by = midY - bh/2;

    if(sparkleTimer>0){
      sparkleTimer--;
      const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff","#8cff7a"];
      for(let i=0;i<26;i++){
        const x = bx + Math.random()*bw;
        const y = by + Math.random()*bh;
        ctx.fillStyle = colors[(Math.random()*colors.length)|0];
        ctx.fillRect(x + (Math.random()*14-7), y + (Math.random()*14-7), 2, 2);
      }
    }

    ctx.fillStyle="rgba(40,40,90,.65)";
    roundRect(bx,by,bw,bh,14,true);

    ctx.strokeStyle="rgba(255,255,255,.2)";
    ctx.lineWidth=2;
    roundRect(bx,by,bw,bh,14,false);

    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    let ty = by + 14 + lineH/2;
    for(const ln of lines){
      ctx.fillText(ln, VW/2, ty);
      ty += lineH;
    }
  }

  // ===== Sky decorations =====
  function drawCloud(x,y,scale=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);
    ctx.fillStyle="#fff";
    ctx.fillRect(8,0,28,14);
    ctx.fillRect(0,6,44,16);
    ctx.fillRect(12,18,28,12);
    ctx.restore();
  }

  function drawRainbow(){
    const cx = VW/2;
    const cy = 250;
    const rings = [
      { r: 260, c: "rgba(255,80,130,.35)" },
      { r: 252, c: "rgba(255,170,70,.35)" },
      { r: 244, c: "rgba(255,230,90,.35)" },
      { r: 236, c: "rgba(120,255,140,.35)" },
      { r: 228, c: "rgba(120,210,255,.35)" },
      { r: 220, c: "rgba(180,140,255,.35)" },
    ];
    ctx.save();
    ctx.lineWidth = 10;
    for(const ring of rings){
      ctx.strokeStyle = ring.c;
      ctx.beginPath();
      ctx.arc(cx, cy, ring.r, Math.PI*1.08, Math.PI*1.92);
      ctx.stroke();
    }
    ctx.restore();
  }

  // ===== Title (more spacing) =====
  function drawArcLine(text, t, yBase, radius, fontPx){
    ctx.save();
    ctx.font = `${fontPx}px 'Press Start 2P'`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";

    const chars = text.split("");
    const total = chars.length;
    const start = Math.PI*1.23;
    const end   = Math.PI*1.77;

    // âœ… extra spacing between letters
    const spacingBoost = 1.12;
    const stepBase = (end-start) / Math.max(1,total-1);
    const step = stepBase * spacingBoost;

    // center the widened arc so it stays in frame
    const span = step * (total-1);
    const start2 = (start + end - span) / 2;

    for(let i=0;i<total;i++){
      const a = start2 + step*i;
      const wave = Math.sin(t/18 + i*0.7) * 2.2;
      const x = VW/2 + Math.cos(a)*radius;
      const y = yBase + Math.sin(a)*radius*0.55 + wave;

      ctx.save();
      ctx.translate(x+2,y+2);
      ctx.rotate(a+Math.PI/2);
      ctx.fillStyle="#000";
      ctx.fillText(chars[i],0,0);
      ctx.restore();

      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(a+Math.PI/2);
      ctx.fillStyle="#ff4fa3";
      ctx.fillText(chars[i],0,0);
      ctx.restore();
    }
    ctx.restore();
  }

  // ===== Game sprites =====
  function drawCheese(x,y){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(1.3,1.3);

    ctx.fillStyle="#ffd24a";
    ctx.beginPath();
    ctx.moveTo(0, 18);
    ctx.lineTo(30, 10);
    ctx.lineTo(30, 30);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle="#e7b93d";
    ctx.fillRect(7, 20, 3, 3);
    ctx.fillRect(14, 17, 3, 3);
    ctx.fillRect(20, 22, 3, 3);

    ctx.fillStyle="rgba(0,0,0,.15)";
    ctx.fillRect(28, 12, 2, 18);

    ctx.restore();
  }

  function drawFlower(x,y,petal){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(1.2,1.2);

    ctx.fillStyle="#2fbf4b";
    ctx.fillRect(12, 22, 4, 30);
    ctx.fillRect(5,  34, 8, 4);
    ctx.fillRect(15, 40, 10, 4);

    ctx.fillStyle=petal;
    ctx.fillRect(6,  8,  16, 14);
    ctx.fillRect(2,  12, 6,  8);
    ctx.fillRect(22, 12, 6,  8);
    ctx.fillRect(10, 4,  8,  6);

    ctx.fillStyle="#ffd24a";
    ctx.fillRect(12, 13, 4, 4);

    ctx.restore();
  }

  function drawRat(x,y,dir){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(dir*1.4, 1.4);

    ctx.fillStyle="#b7b0b8";
    ctx.fillRect(-10, -6, 20, 12);

    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(8, -10, 14, 14);

    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(18, -14, 6, 6);
    ctx.fillStyle="#e7a7b8";
    ctx.fillRect(20, -12, 2, 2);

    ctx.fillStyle="#ff5aa5";
    ctx.fillRect(14, -16, 4, 4);
    ctx.fillRect(19, -16, 4, 4);
    ctx.fillRect(18, -15, 1, 1);

    ctx.fillStyle="#000";
    ctx.fillRect(14, -5, 2, 2);
    ctx.fillRect(22, -2, 2, 2);

    ctx.fillStyle="#caa1aa";
    ctx.fillRect(-18, -2, 8, 2);

    ctx.fillStyle="#8e8790";
    ctx.fillRect(-6, 6, 6, 3);
    ctx.fillRect(4,  6, 6, 3);

    ctx.restore();
  }

  // ===== Game state =====
  const flowers = [];
  let cheese = null;

  const rat = { x: 70, y: GROUND_Y + 210, dir: 1, speed: 3.0, target: null, busy:false };

  // âœ… Tap anywhere to feed (no grass restriction)
  function dropCheese(gx,gy){
    gx = clamp(gx, 20, VW-20);
    gy = clamp(gy, 120, VH-90);

    cheese = { x: gx-12, y: gy-16 };
    rat.target = { x: cheese.x, y: cheese.y };
    rat.busy = true;

    showBubble("Nom Nom");
    chime();
  }

  function updateRat(){
    if(!rat.busy || !rat.target) return;
    const dx = rat.target.x - rat.x;
    const dy = rat.target.y - rat.y;
    const d = Math.hypot(dx,dy);
    rat.dir = dx >= 0 ? 1 : -1;

    if(d < 7){
      if(cheese){
        const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ff7aa5"];
        flowers.push({ x: cheese.x - 10, y: cheese.y - 64, c: colors[(Math.random()*colors.length)|0] });
        cheese = null;

        showBubble(messages[msgIndex % messages.length]);
        msgIndex++;
        chime();
      }
      rat.busy = false;
      rat.target = null;
      return;
    }

    rat.x += (dx/d) * rat.speed;
    rat.y += (dy/d) * rat.speed;
    rat.x = clamp(rat.x, 22, VW-22);
    rat.y = clamp(rat.y, GROUND_Y+60, VH-90);
  }

  canvas.addEventListener("pointerdown",(e)=>{
    safeResumeAudio();
    tryPlaySofia();
    const p = toGameCoords(e.clientX, e.clientY);
    dropCheese(p.x, p.y);
  });

  // ===== Render loop =====
  let t = 0;
  function draw(){
    t++;

    ctx.fillStyle="#000";
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

    ctx.save();
    ctx.translate(offX, offY);
    ctx.scale(scale, scale);

    // sky
    const sky = ctx.createLinearGradient(0,0,0,VH);
    sky.addColorStop(0,"#79b7ff");
    sky.addColorStop(1,"#bfe6ff");
    ctx.fillStyle = sky;
    ctx.fillRect(0,0,VW,VH);

    // rainbow
    drawRainbow();

    // more moving clouds (4 layers)
    const s1 = (t*0.40) % (VW+220);
    const s2 = (t*0.55) % (VW+240);
    const s3 = (t*0.70) % (VW+260);
    const s4 = (t*0.90) % (VW+280);
    drawCloud(-80 + s1*0.70, 46, 0.85);
    drawCloud( 20 + s2*0.60, 74, 1.00);
    drawCloud(-130+ s3*0.55, 104, 1.05);
    drawCloud( 60 + s4*0.45, 128, 0.78);

    // ground
    ctx.fillStyle="#155f28";
    ctx.fillRect(0,GROUND_Y,VW,VH-GROUND_Y);
    ctx.fillStyle="rgba(0,0,0,.12)";
    for(let y=GROUND_Y; y<VH; y+=18) ctx.fillRect(0,y,VW,3);

    // confetti sparkles on grass
    for(let i=0;i<60;i++){
      const x = (Math.random()*VW)|0;
      const y = (GROUND_Y+20 + Math.random()*(VH-GROUND_Y-80))|0;
      const c = ["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff"][i%5];
      ctx.fillStyle=c;
      ctx.fillRect(x,y,2,2);
    }

    // title (more spacing)
    drawArcLine("Happy Valentineâ€™s Day", t, 74, 105, 13);
    drawArcLine("My bby",            t, 102, 85, 13);

    // bubble (middle sky)
    if(bubbleTimer>0) bubbleTimer--;
    drawBubbleMiddleSky();

    // objects
    flowers.forEach(f => drawFlower(f.x, f.y, f.c));
    if(cheese) drawCheese(cheese.x, cheese.y);

    updateRat();
    drawRat(Math.round(rat.x), Math.round(rat.y), rat.dir);

    // bottom signature (bigger bar so always visible)
    ctx.fillStyle="rgba(0,0,0,.25)";
    ctx.fillRect(0, VH-58, VW, 58);

    ctx.fillStyle="#fff";
    ctx.font="13px 'Press Start 2P'";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(sigText, VW/2, VH-29);

    ctx.restore();
    requestAnimationFrame(draw);
  }

  showBubble("Tap anywhere to drop cheese ðŸ§€");
  draw();
})();
</script>
</body>
</html>
