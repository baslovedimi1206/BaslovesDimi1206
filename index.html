<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // Fit canvas to iPhone + desktop
  function resize(){
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    canvas.width  = Math.floor(window.innerWidth  * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
  }
  window.addEventListener("resize", resize);
  resize();

  // Safe cute chime
  let muted = false;
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  function chime(){
    if(muted) return;
    const now = AC.currentTime;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type="triangle";
    o.frequency.setValueAtTime(660, now);
    o.frequency.exponentialRampToValueAtTime(990, now+0.09);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
    o.connect(g).connect(AC.destination);
    o.start(now); o.stop(now+0.18);
  }
  const muteBtn = document.getElementById("muteBtn");
  if(muteBtn){
    muteBtn.onclick = () => {
      muted = !muted;
      muteBtn.textContent = muted ? "Unmute" : "Mute";
      chime();
    };
  }

  // ===== Love messages (20) =====
  const messages = [
    "I'm so proud of you.",
    "You are my sunshine.",
    "You are the best girlfriend.",
    "You make my days brighter.",
    "I believe in you always.",
    "You are so strong.",
    "You are so kind.",
    "You are so beautiful inside and out.",
    "You make me feel safe.",
    "Thank you for being you.",
    "I love your smile so much.",
    "You deserve all the good things.",
    "You inspire me every day.",
    "You are my favorite person.",
    "I‚Äôm grateful for us.",
    "You make my heart feel calm.",
    "You are doing amazing, my bby.",
    "I‚Äôm always cheering for you.",
    "You are more than enough.",
    "I choose you, again and again."
  ];
  let msgIndex = 0;

  // message bubble in the sky
  let skyText = "Tap cheese to plant tulips üå∑";
  let skyTimer = 0; // frames
  function showSkyMessage(text){
    skyText = text;
    skyTimer = 240; // ~4 seconds at 60fps
  }

  // ===== World state =====
  const plantedTulips = [];
  let t = 0;

  function irand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ===== Drawing helpers =====
  function pixelCloud(x,y,s){
    const px = 6*s;
    const blocks=[[1,0],[2,0],[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[2,2],[3,2]];
    ctx.fillStyle="#fff";
    blocks.forEach(([bx,by])=>ctx.fillRect(Math.round(x+bx*px),Math.round(y+by*px),px,px));
  }

  function tulip(x,y,petal){
    // bigger pixel tulip
    ctx.fillStyle="#2fbf4b";
    ctx.fillRect(x+6,y+16,4,26);
    ctx.fillRect(x+2,y+28,6,4);
    ctx.fillRect(x+10,y+30,6,4);

    ctx.fillStyle=petal;
    ctx.fillRect(x+4,y+6,12,10);
    ctx.fillRect(x+2,y+10,4,8);
    ctx.fillRect(x+16,y+10,4,8);
    ctx.fillRect(x+8,y+4,4,4);

    ctx.fillStyle="rgba(0,0,0,.12)";
    ctx.fillRect(x+4,y+16,12,2);
  }

  function cheese(x,y){
    ctx.fillStyle="#ffd24a";
    ctx.fillRect(x,y,18,14);
    ctx.clearRect(x+14,y,4,4); // bite

    ctx.fillStyle="#e7b93d";
    ctx.fillRect(x+4,y+4,2,2);
    ctx.fillRect(x+10,y+7,2,2);
    ctx.fillRect(x+6,y+10,2,2);

    ctx.fillStyle="rgba(0,0,0,.12)";
    ctx.fillRect(x,y+12,18,2);
  }

  // Cute pixel ‚Äúgirl rat‚Äù (simple bow + tail)
  function girlRat(x,y,dir){
    // dir: -1 left, +1 right
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(dir,1);

    // shadow
    ctx.fillStyle="rgba(0,0,0,.15)";
    ctx.fillRect(-8, 14, 16, 3);

    // tail
    ctx.fillStyle="#caa1aa";
    ctx.fillRect(-14, 10, 6, 2);
    ctx.fillRect(-16, 9, 2, 2);

    // body
    ctx.fillStyle="#b7b0b8";
    ctx.fillRect(-8, 4, 16, 10);

    // head
    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(2, 0, 10, 10);

    // ear
    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(8, -2, 4, 4);
    ctx.fillStyle="#e7a7b8";
    ctx.fillRect(9, -1, 2, 2);

    // face details
    ctx.fillStyle="#000";
    ctx.fillRect(9, 4, 1, 1); // eye
    ctx.fillRect(12, 6, 2, 1); // nose
    ctx.fillStyle="#fff";
    ctx.fillRect(10, 4, 1, 1); // sparkle eye

    // bow (girly)
    ctx.fillStyle="#ff5aa5";
    ctx.fillRect(6, -3, 3, 3);
    ctx.fillRect(10, -3, 3, 3);
    ctx.fillRect(9, -2, 1, 1);

    // feet
    ctx.fillStyle="#8e8790";
    ctx.fillRect(-6, 13, 4, 2);
    ctx.fillRect(2, 13, 4, 2);

    ctx.restore();
  }

  // ===== Rat + Cheese interaction =====
  const rat = {
    x: 80,
    y: 0,
    speed: 2.2,
    dir: 1,
    target: null, // {x,y}
    busy: false
  };

  let currentCheese = null; // {x,y}

  function getHorizon(H){ return Math.floor(H * 0.40); }

  function placeCheeseAt(x,y){
    const H = window.innerHeight;
    const horizon = getHorizon(H);

    // only in grass
    if(y < horizon+10) return;

    currentCheese = { x: Math.round(x-9), y: Math.round(y-7) };
    rat.target = { x: currentCheese.x + 6, y: currentCheese.y + 10 };
    rat.busy = true;

    // rat looks toward target
    rat.dir = (rat.target.x >= rat.x) ? 1 : -1;

    showSkyMessage("Cheese spotted! üßÄ");
    chime();
  }

  function updateRat(){
    if(!rat.busy || !rat.target) return;

    const dx = rat.target.x - rat.x;
    const dy = rat.target.y - rat.y;
    const dist = Math.hypot(dx,dy);

    if(dist < 3){
      // "eat" cheese -> plant tulip
      if(currentCheese){
        const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ff7aa5"];
        plantedTulips.push({
          x: currentCheese.x - 3,
          y: currentCheese.y - 26,
          c: colors[Math.floor(Math.random()*colors.length)]
        });
        currentCheese = null;

        // show next love sentence
        showSkyMessage(messages[msgIndex]);
        msgIndex = (msgIndex + 1) % messages.length;
        chime();
      }
      rat.busy = false;
      rat.target = null;
      return;
    }

    const vx = (dx / dist) * rat.speed;
    const vy = (dy / dist) * rat.speed;

    rat.x += vx;
    rat.y += vy;
    rat.dir = (vx >= 0) ? 1 : -1;
  }

  // ===== Main draw loop =====
  function draw(){
    t++;
    const W = window.innerWidth, H = window.innerHeight;
    const horizon = getHorizon(H);

    // background sky
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"#79b7ff");
    g.addColorStop(1,"#bfe6ff");
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    // clouds
    pixelCloud(40 + Math.sin(t/80)*6, 70, 1.1);
    pixelCloud(220 + Math.sin(t/95)*7, 110, 1.3);

    // grass
    ctx.fillStyle="#155f28"; ctx.fillRect(0,horizon,W,H-horizon);
    ctx.fillStyle="rgba(0,0,0,.12)";
    for(let y=horizon;y<H;y+=18) ctx.fillRect(0,y,W,3);

    // tiny confetti pixels
    for(let i=0;i<60;i++){
      const x = irand(0,W-2);
      const y = irand(horizon+30, H-12);
      const c = ["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff"][irand(0,4)];
      ctx.fillStyle=c; ctx.fillRect(x,y,2,2);
    }

    // planted tulips
    plantedTulips.forEach(p => tulip(p.x, p.y, p.c));

    // current cheese (only one at a time)
    if(currentCheese){
      // bob slightly
      const bob = Math.sin(t/20)*1.2;
      cheese(currentCheese.x, currentCheese.y + bob);
    }

    // rat
    // keep rat on grass line-ish if no target
    if(!rat.busy){
      rat.y = clamp(rat.y, horizon+40, H-40);
      if(rat.y === 0) rat.y = horizon+80;
    }
    updateRat();
    girlRat(Math.round(rat.x), Math.round(rat.y), rat.dir);

    // Sky text (top center)
    // (draw as pixel text with background)
    if(skyTimer > 0) skyTimer--;
    const textToShow = skyTimer > 0 ? skyText : "Tap to drop cheese üßÄ  (rat will plant tulips üå∑)";
    ctx.font = "14px 'Press Start 2P'";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // bubble
    const padding = 14;
    const maxW = Math.min(560, W - 30);
    const lines = wrapText(textToShow, maxW - padding*2, ctx);
    const bubbleH = lines.length * 20 + padding*2;
    const bubbleW = maxW;
    const bx = (W - bubbleW) / 2;
    const by = 54;

    ctx.fillStyle = "rgba(27,21,48,.55)";
    roundRect(bx, by, bubbleW, bubbleH, 14, true);
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 2;
    roundRect(bx, by, bubbleW, bubbleH, 14, false);

    ctx.fillStyle = "#fff";
    ctx.shadowColor = "rgba(0,0,0,.45)";
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 2;
    ctx.shadowBlur = 0;

    let ty = by + padding + 10;
    lines.forEach(line=>{
      ctx.fillText(line, W/2, ty);
      ty += 20;
    });

    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    requestAnimationFrame(draw);
  }

  // text wrap helper
  function wrapText(text, maxWidth, ctx){
    const words = text.split(" ");
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? line + " " + w : w;
      if(ctx.measureText(test).width <= maxWidth){
        line = test;
      } else {
        if(line) lines.push(line);
        line = w;
      }
    }
    if(line) lines.push(line);
    return lines.slice(0, 4); // keep it neat
  }

  function roundRect(x, y, w, h, r, fill){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    if(fill) ctx.fill();
    else ctx.stroke();
  }

  // Interaction: tap anywhere => drop cheese there
  canvas.addEventListener("pointerdown", (e) => {
    if(AC.state==="suspended") AC.resume();
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX-rect.left);
    const my = (e.clientY-rect.top);
    placeCheeseAt(mx, my);
  });

  // Start
  rat.y = getHorizon(window.innerHeight) + 90;
  showSkyMessage("Tap anywhere to drop cheese üßÄ");
  draw();
})();
</script>
