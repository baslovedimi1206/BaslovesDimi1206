<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Happy Valentineâ€™s Day</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    body{font-family:"Press Start 2P",system-ui}
    .wrap{position:relative;width:100vw;height:100vh}
    canvas{width:100%;height:100%;display:block;image-rendering:pixelated}

    /* Mute button - safe for iPhone / Instagram browser */
    .btn{
      position:absolute;
      right:14px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 140px);
      background:rgba(0,0,0,.35);
      border:2px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px;
      backdrop-filter: blur(6px);
    }
    button{
      font-family:"Press Start 2P";
      font-size:10px;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #000;
      background:#fff2fb;
      color:#000;
      box-shadow:2px 2px 0 #000;
      cursor:pointer;
    }
    button:active{transform:translate(1px,1px);box-shadow:1px 1px 0 #000}
  </style>
</head>
<body>
<div class="wrap">
  <canvas id="c"></canvas>

  <div class="btn">
    <button id="muteBtn">Mute</button>
  </div>

  <!-- ONLY Sofia mp3 -->
  <audio id="bgm" loop preload="auto">
    <source src="AUD-20210820-WA0076.mp3" type="audio/mpeg">
  </audio>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // =========================
  // Virtual game screen
  // =========================
  const VW = 360, VH = 640;
  let scale = 1, offX = 0, offY = 0;

  function resize(){
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);

    // "contain" so everything stays visible
    scale = Math.min(window.innerWidth / VW, window.innerHeight / VH);
    offX = (window.innerWidth  - VW * scale) / 2;
    offY = (window.innerHeight - VH * scale) / 2;
  }
  window.addEventListener("resize", resize);
  resize();

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

  function toGameCoords(clientX, clientY){
    const rect = canvas.getBoundingClientRect();
    let x = (clientX - rect.left - offX) / scale;
    let y = (clientY - rect.top  - offY) / scale;
    x = clamp(x, 0, VW);
    y = clamp(y, 0, VH);
    return { x, y };
  }

  // =========================
  // Audio (Sofia only + chime)
  // =========================
  const bgm = document.getElementById("bgm");
  let muted = false;

  const AC = new (window.AudioContext||window.webkitAudioContext)();
  const safeResumeAudio = ()=>{ if(AC.state==="suspended") AC.resume(); };

  function chime(){
    if(muted) return;
    const now = AC.currentTime;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type="triangle";
    o.frequency.setValueAtTime(760, now);
    o.frequency.exponentialRampToValueAtTime(1120, now+0.09);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.10, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
    o.connect(g).connect(AC.destination);
    o.start(now); o.stop(now+0.18);
  }

  async function tryPlaySofia(){
    try { bgm.muted = muted; await bgm.play(); } catch(e) {}
  }

  document.getElementById("muteBtn").onclick = () => {
    muted = !muted;
    bgm.muted = muted;
    document.getElementById("muteBtn").textContent = muted ? "Unmute" : "Mute";
    chime();
  };

  // =========================
  // Layout
  // =========================
  const GROUND_Y = 250;                 // slightly higher so bottom text never gets cut
  const FOOTER_H = 64;
  const FOOTER_Y = VH - 110;            // lifted up for iPhone browser bars
  const sigText  = "I love you, Dimi";

  // =========================
  // 20 Messages (loop)
  // =========================
  const messages = [
    "I'm so proud of you.",
    "You are my sunshine.",
    "You are the best girlfriend.",
    "You make my days brighter.",
    "I believe in you always.",
    "You are so strong.",
    "You are so kind.",
    "You inspire me every day.",
    "I love your smile so much.",
    "I choose you, again and again.",
    "You mean the world to me.",
    "You are my favorite person.",
    "You make my heart feel calm.",
    "I'm grateful for you every day.",
    "You deserve all good things.",
    "Your laugh is my favorite sound.",
    "Being with you feels like home.",
    "You are more than enough.",
    "I adore everything about you.",
    "Forever and always, my bby ðŸ’—"
  ];
  let msgIndex = 0;

  let bubbleText = "Tap anywhere to drop cheese ðŸ§€";
  let bubbleTimer = 220;
  let sparkleTimer = 0;

  function showBubble(t){
    bubbleText = t;
    bubbleTimer = 260;
    sparkleTimer = 90;
  }

  // =========================
  // Helpers
  // =========================
  function roundRect(x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    fill ? ctx.fill() : ctx.stroke();
  }

  function wrapLines(text, maxWidth){
    const words = text.split(" ");
    const lines = [];
    let line = "";
    for(const w of words){
      const test = line ? (line + " " + w) : w;
      if(ctx.measureText(test).width <= maxWidth) line = test;
      else { if(line) lines.push(line); line = w; }
    }
    if(line) lines.push(line);
    return lines.slice(0, 3);
  }

  // =========================
  // Background: meadow like screenshot
  // =========================
  // seeded random so flowers donâ€™t flicker
  let seed = 1337;
  function rnd(){
    seed = (seed * 1664525 + 1013904223) >>> 0;
    return seed / 4294967296;
  }

  const meadowDots = [];
  const meadowFlowers = [];
  const NUM_DOTS = 420;
  const NUM_TINY = 240;

  function initMeadow(){
    meadowDots.length = 0;
    meadowFlowers.length = 0;

    for(let i=0;i<NUM_DOTS;i++){
      meadowDots.push({
        x: Math.floor(rnd()*VW),
        y: Math.floor(GROUND_Y + 12 + rnd()*(VH - GROUND_Y - 150)),
        c: ["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff","#8cff7a"][Math.floor(rnd()*6)],
        s: rnd() < 0.75 ? 2 : 3
      });
    }

    for(let i=0;i<NUM_TINY;i++){
      const y = Math.floor(GROUND_Y + 8 + rnd()*(VH - GROUND_Y - 120));
      meadowFlowers.push({
        x: Math.floor(rnd()*VW),
        y,
        // smaller on far (higher), bigger on near (lower)
        sc: 0.55 + ( (y - GROUND_Y) / (VH - GROUND_Y) ) * 0.85,
        pet: ["#ff74b9","#ffd24a","#7fd6ff","#b68cff","#ff7aa5","#ffffff"][Math.floor(rnd()*6)],
        ctr: ["#ffd24a","#fff2fb","#ffffff"][Math.floor(rnd()*3)]
      });
    }
  }
  initMeadow();

  function drawSky(t){
    // smooth sky gradient
    const sky = ctx.createLinearGradient(0,0,0,VH);
    sky.addColorStop(0,"#5fb0ff");
    sky.addColorStop(1,"#bfe6ff");
    ctx.fillStyle = sky;
    ctx.fillRect(0,0,VW,VH);

    // soft rainbow arc behind title (subtle, like example)
    const cx = VW/2;
    const cy = 252;
    const rings = [
      { r: 260, c: "rgba(255,80,130,.18)" },
      { r: 252, c: "rgba(255,170,70,.18)" },
      { r: 244, c: "rgba(255,230,90,.18)" },
      { r: 236, c: "rgba(120,255,140,.18)" },
      { r: 228, c: "rgba(120,210,255,.18)" },
      { r: 220, c: "rgba(180,140,255,.18)" },
    ];
    ctx.save();
    ctx.lineWidth = 10;
    for(const ring of rings){
      ctx.strokeStyle = ring.c;
      ctx.beginPath();
      ctx.arc(cx, cy, ring.r, Math.PI*1.10, Math.PI*1.90);
      ctx.stroke();
    }
    ctx.restore();

    // pixel clouds
    const shiftA = (t*0.42) % (VW+220);
    const shiftB = (t*0.60) % (VW+240);
    const shiftC = (t*0.78) % (VW+260);

    drawCloud(-90 + shiftA*0.85, 60, 0.95);
    drawCloud( 40 + shiftB*0.70, 92, 1.10);
    drawCloud(-140+ shiftC*0.62, 122, 0.85);
  }

  function drawCloud(x,y,sc=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(sc,sc);
    ctx.fillStyle="#fff";
    ctx.fillRect(10,0,28,14);
    ctx.fillRect(0,7,46,16);
    ctx.fillRect(14,20,28,12);
    ctx.restore();
  }

  function drawHills(t){
    // rolling hill layers like screenshot
    const wave1 = (x)=> Math.sin((x/44) + t/80) * 3;
    const wave2 = (x)=> Math.sin((x/56) + t/95) * 2;

    // back hill
    ctx.fillStyle="#2d8a37";
    ctx.beginPath();
    ctx.moveTo(0, GROUND_Y-24);
    for(let x=0; x<=VW; x+=8){
      const y = (GROUND_Y-24) + wave2(x);
      ctx.lineTo(x,y);
    }
    ctx.lineTo(VW, GROUND_Y+10);
    ctx.lineTo(0,  GROUND_Y+10);
    ctx.closePath();
    ctx.fill();

    // front hill
    ctx.fillStyle="#1f7a2f";
    ctx.beginPath();
    ctx.moveTo(0, GROUND_Y-8);
    for(let x=0; x<=VW; x+=8){
      const y = (GROUND_Y-8) + wave1(x);
      ctx.lineTo(x,y);
    }
    ctx.lineTo(VW, GROUND_Y+18);
    ctx.lineTo(0,  GROUND_Y+18);
    ctx.closePath();
    ctx.fill();
  }

  function drawMeadow(){
    // base grass
    ctx.fillStyle="#155f28";
    ctx.fillRect(0,GROUND_Y,VW,VH-GROUND_Y);

    // subtle stripe lines
    ctx.fillStyle="rgba(0,0,0,.12)";
    for(let y=GROUND_Y; y<VH; y+=18) ctx.fillRect(0,y,VW,3);

    // dots/sparkles
    for(const d of meadowDots){
      ctx.fillStyle = d.c;
      ctx.fillRect(d.x, d.y, d.s, d.s);
    }

    // tiny flowers sprinkled everywhere
    for(const f of meadowFlowers){
      drawTinyFlower(f.x, f.y, f.pet, f.ctr, f.sc);
    }
  }

  function drawTinyFlower(x,y,petal,center,sc){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(sc,sc);

    // stem
    ctx.fillStyle="#2fbf4b";
    ctx.fillRect(0,6,2,10);

    // petals (simple 4-petal pixel look)
    ctx.fillStyle=petal;
    ctx.fillRect(-2,2,6,4);
    ctx.fillRect(0,0,2,8);

    // center
    ctx.fillStyle=center;
    ctx.fillRect(0,3,2,2);

    ctx.restore();
  }

  // =========================
  // Title (arc + more spacing, always in frame)
  // =========================
  function drawTitle(text, y, fontPx, letterSpacing){
  ctx.save();
  ctx.font = `${fontPx}px 'Press Start 2P'`;
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";

  // measure total width with spacing
  let totalWidth = 0;
  for(const ch of text){
    totalWidth += ctx.measureText(ch).width + letterSpacing;
  }

  let x = VW/2 - totalWidth/2;

  for(const ch of text){
    ctx.save();
    ctx.translate(x, y);

    // glow
    ctx.shadowColor = "#ff66c4";
    ctx.shadowBlur = 12;

    ctx.fillStyle = "#ff4fa3";
    ctx.fillText(ch, 0, 0);

    ctx.shadowBlur = 0;
    ctx.restore();

    x += ctx.measureText(ch).width + letterSpacing;
  }

  ctx.restore();
}





  // =========================
  // Message bubble (middle of sky)
  // =========================
  function drawBubbleMiddleSky(){
    const skyTop = 130;
    const skyBottom = GROUND_Y - 22;
    const midY = (skyTop + skyBottom) / 2;

    const bw = VW - 56;
    const bx = (VW - bw) / 2;

    ctx.font="11px 'Press Start 2P'";
    const lines = wrapLines(bubbleText, bw - 28);
    const lineH = 16;
    const bh = 20 + lines.length * lineH;
    const by = midY - bh/2;

    // rainbow sparkles around bubble
    if(sparkleTimer>0){
      sparkleTimer--;
      const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff","#8cff7a"];
      for(let i=0;i<30;i++){
        const x = bx + Math.random()*bw;
        const y = by + Math.random()*bh;
        ctx.fillStyle = colors[(Math.random()*colors.length)|0];
        ctx.fillRect(x + (Math.random()*14-7), y + (Math.random()*14-7), 2, 2);
      }
    }

    ctx.fillStyle="rgba(40,40,90,.65)";
    roundRect(bx,by,bw,bh,14,true);

    ctx.strokeStyle="rgba(255,255,255,.20)";
    ctx.lineWidth=2;
    roundRect(bx,by,bw,bh,14,false);

    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    let ty = by + 12 + lineH/2;
    for(const ln of lines){
      ctx.fillText(ln, VW/2, ty);
      ty += lineH;
    }
  }

  // =========================
  // Game sprites (rat/cheese/flowers)
  // =========================
  function drawCheese(x,y){
    // bigger, more â€œcheeseâ€ look
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(1.35,1.35);

    // wedge
    ctx.fillStyle="#ffd24a";
    ctx.beginPath();
    ctx.moveTo(0, 18);
    ctx.lineTo(32, 8);
    ctx.lineTo(32, 30);
    ctx.closePath();
    ctx.fill();

    // holes
    ctx.fillStyle="#e7b93d";
    ctx.fillRect(8, 20, 3, 3);
    ctx.fillRect(16, 16, 3, 3);
    ctx.fillRect(22, 23, 3, 3);
    ctx.fillRect(26, 15, 2, 2);

    // side shade
    ctx.fillStyle="rgba(0,0,0,.15)";
    ctx.fillRect(30, 10, 2, 18);

    ctx.restore();
  }

  function drawFlower(x,y,petal){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(1.25,1.25);

    // stem + leaves
    ctx.fillStyle="#2fbf4b";
    ctx.fillRect(12, 24, 4, 32);
    ctx.fillRect(6,  38, 10, 4);
    ctx.fillRect(16, 44, 12, 4);

    // petals (rounder feel)
    ctx.fillStyle=petal;
    ctx.fillRect(6, 10, 16, 14);
    ctx.fillRect(2, 14, 6,  10);
    ctx.fillRect(22,14, 6,  10);
    ctx.fillRect(10,6,  8,  8);

    // center
    ctx.fillStyle="#ffd24a";
    ctx.fillRect(12, 16, 4, 4);

    ctx.restore();
  }

  function drawRat(x,y,dir){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(dir*1.45, 1.45);

    // body
    ctx.fillStyle="#b7b0b8";
    ctx.fillRect(-10, -6, 22, 12);

    // head
    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(10, -10, 14, 14);

    // ear
    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(20, -14, 6, 6);
    ctx.fillStyle="#e7a7b8";
    ctx.fillRect(22, -12, 2, 2);

    // bow
    ctx.fillStyle="#ff5aa5";
    ctx.fillRect(16, -16, 4, 4);
    ctx.fillRect(21, -16, 4, 4);
    ctx.fillRect(20, -15, 1, 1);

    // eye + nose
    ctx.fillStyle="#000";
    ctx.fillRect(16, -5, 2, 2);
    ctx.fillRect(24, -2, 2, 2);

    // tail
    ctx.fillStyle="#caa1aa";
    ctx.fillRect(-18, -2, 8, 2);

    // feet
    ctx.fillStyle="#8e8790";
    ctx.fillRect(-6, 6, 6, 3);
    ctx.fillRect(5,  6, 6, 3);

    ctx.restore();
  }

  // =========================
  // Game state
  // =========================
  const plantedFlowers = [];
  let cheese = null;

  const rat = {
    x: 70,
    y: GROUND_Y + 220,
    dir: 1,
    speed: 3.0,
    target: null,
    busy:false
  };

  function dropCheese(gx,gy){
    // allow tap anywhere, but keep targets in the â€œplay areaâ€
    gx = clamp(gx, 22, VW-22);
    gy = clamp(gy, 120, VH-120);

    cheese = { x: gx-14, y: gy-18 };
    rat.target = { x: cheese.x, y: cheese.y };
    rat.busy = true;

    showBubble("Cheese spotted! ðŸ§€");
    chime();
  }

  function updateRat(){
    if(!rat.busy || !rat.target) return;
    const dx = rat.target.x - rat.x;
    const dy = rat.target.y - rat.y;
    const d = Math.hypot(dx,dy);
    rat.dir = dx >= 0 ? 1 : -1;

    if(d < 8){
      if(cheese){
        const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ff7aa5"];
        plantedFlowers.push({
          x: cheese.x - 10,
          y: cheese.y - 72,
          c: colors[(Math.random()*colors.length)|0]
        });
        cheese = null;

        showBubble(messages[msgIndex % messages.length]);
        msgIndex++;
        chime();
      }
      rat.busy = false;
      rat.target = null;
      return;
    }

    rat.x += (dx/d) * rat.speed;
    rat.y += (dy/d) * rat.speed;

    rat.x = clamp(rat.x, 22, VW-22);
    rat.y = clamp(rat.y, GROUND_Y+40, VH-130);
  }

  // =========================
  // Input
  // =========================
  canvas.addEventListener("pointerdown",(e)=>{
    safeResumeAudio();
    tryPlaySofia();
    const p = toGameCoords(e.clientX, e.clientY);
    dropCheese(p.x, p.y);
  });

  // =========================
  // Render loop
  // =========================
  let t = 0;
  function draw(){
    t++;

    // outside area
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

    // game frame
    ctx.save();
    ctx.translate(offX, offY);
    ctx.scale(scale, scale);

    // sky + rainbow + clouds
    drawSky(t);

    // hills + meadow
    drawHills(t);
    drawMeadow();

    // title (arc, spaced, stays in frame)
   drawTitle("Happy Valentineâ€™s Day My bby", 120, 16, 6);



    // bubble (middle sky)
    if(bubbleTimer>0) bubbleTimer--;
    drawBubbleMiddleSky();

    // planted flowers from cheese-eating
    for(const f of plantedFlowers) drawFlower(f.x, f.y, f.c);

    // cheese
    if(cheese) drawCheese(cheese.x, cheese.y);

    // rat
    updateRat();
    drawRat(Math.round(rat.x), Math.round(rat.y), rat.dir);

    // footer (lifted so iPhone browser never cuts it)
    ctx.fillStyle="rgba(0,0,0,.32)";
    roundRect(16, FOOTER_Y, VW-32, FOOTER_H, 14, true);

    ctx.fillStyle="#fff";
    ctx.font="11px 'Press Start 2P'";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(sigText, VW/2, FOOTER_Y + FOOTER_H/2);

    ctx.restore();
    requestAnimationFrame(draw);
  }

  showBubble("Tap anywhere to drop cheese ðŸ§€");
  draw();
})();
</script>
</body>
</html>
