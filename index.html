<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Happy Valentineâ€™s Day ðŸ’—</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    body{font-family:"Press Start 2P",system-ui}
    .wrap{position:relative;width:100vw;height:100vh}
    canvas{width:100%;height:100%;display:block;image-rendering:pixelated}

    .btn{
      position:absolute;
      right:14px;
      bottom:76px;
      background:rgba(0,0,0,.35);
      border:2px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px;
      backdrop-filter: blur(6px);
    }
    button{
      font-family:"Press Start 2P";
      font-size:10px;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #000;
      background:#fff2fb;
      color:#000;
      box-shadow:2px 2px 0 #000;
      cursor:pointer;
    }
    button:active{transform:translate(1px,1px);box-shadow:1px 1px 0 #000}
  </style>
</head>
<body>
<div class="wrap">
  <canvas id="c"></canvas>

  <div class="btn">
    <button id="muteBtn">Mute</button>
  </div>

  <audio id="bgm" loop preload="auto">
    <source src="AUD-20210820-WA0076.mp3" type="audio/mpeg">
  </audio>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // ===== Virtual game resolution =====
  const VW = 360, VH = 640;
  let scale = 1, offX = 0, offY = 0;
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);

    scale = Math.min(window.innerWidth / VW, window.innerHeight / VH);
    offX = (window.innerWidth  - VW * scale) / 2;
    offY = (window.innerHeight - VH * scale) / 2;
  }
  window.addEventListener("resize", resize);
  resize();

  function toGameCoords(clientX, clientY){
    const rect = canvas.getBoundingClientRect();
    return {
      x: (clientX - rect.left - offX) / scale,
      y: (clientY - rect.top  - offY) / scale
    };
  }

  // ===== Audio =====
  const bgm = document.getElementById("bgm");
  let muted = false;
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  function safeResumeAudio(){ if(AC.state==="suspended") AC.resume(); }

  function chime(){
    if(muted) return;
    const now = AC.currentTime;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type="triangle";
    o.frequency.setValueAtTime(760, now);
    o.frequency.exponentialRampToValueAtTime(1120, now+0.09);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.16);
    o.connect(g).connect(AC.destination);
    o.start(now); o.stop(now+0.18);
  }

  async function tryPlaySofia(){
    try { bgm.muted = muted; await bgm.play(); } catch(e) {}
  }

  document.getElementById("muteBtn").onclick = () => {
    muted = !muted;
    bgm.muted = muted;
    document.getElementById("muteBtn").textContent = muted ? "Unmute" : "Mute";
    chime();
  };

  // ===== Game layout =====
  const GROUND_Y = 270;
  const sigText = "I love you, Dimi ðŸ’";

  // ===== Messages =====
  const messages = [
    "I'm so proud of you.",
    "You are my sunshine.",
    "You are the best girlfriend.",
    "You make my days brighter.",
    "I believe in you always.",
    "You are so strong.",
    "You are so kind.",
    "You inspire me every day.",
    "I love your smile so much.",
    "I choose you, again and again."
  ];
  let msgIndex = 0;
  let bubbleText = "Tap anywhere to drop cheese ðŸ§€";
  let bubbleTimer = 220;
  let sparkleTimer = 0;

  function showBubble(t){
    bubbleText = t;
    bubbleTimer = 260;
    sparkleTimer = 80;
  }

  // ===== Sprites =====
  function drawCloud(x,y){
    ctx.fillStyle="#fff";
    ctx.fillRect(x+6,y,24,12);
    ctx.fillRect(x,y+6,36,14);
    ctx.fillRect(x+10,y+16,22,10);
  }

  function drawCheese(x,y){
    // nicer wedge cheese + holes
    ctx.fillStyle="#ffd24a";
    ctx.beginPath();
    ctx.moveTo(x, y+20);
    ctx.lineTo(x+30, y+10);
    ctx.lineTo(x+30, y+30);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle="#e7b93d";
    ctx.fillRect(x+7,  y+20, 3, 3);
    ctx.fillRect(x+14, y+17, 3, 3);
    ctx.fillRect(x+20, y+22, 3, 3);

    ctx.fillStyle="rgba(0,0,0,.15)";
    ctx.fillRect(x+28, y+12, 2, 18);
  }

  function drawFlower(x,y,petal){
    ctx.fillStyle="#2fbf4b";
    ctx.fillRect(x+12, y+22, 4, 30);
    ctx.fillRect(x+5,  y+34, 8, 4);
    ctx.fillRect(x+15, y+40, 10, 4);

    ctx.fillStyle=petal;
    ctx.fillRect(x+6,  y+8,  16, 14);
    ctx.fillRect(x+2,  y+12, 6,  8);
    ctx.fillRect(x+22, y+12, 6,  8);
    ctx.fillRect(x+10, y+4,  8,  6);

    ctx.fillStyle="#ffd24a";
    ctx.fillRect(x+12, y+13, 4, 4);
  }

  function drawRat(x,y,dir){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(dir,1);

    ctx.fillStyle="#b7b0b8";
    ctx.fillRect(-10, -6, 20, 12);

    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(8, -10, 14, 14);

    ctx.fillStyle="#c3bcc4";
    ctx.fillRect(18, -14, 6, 6);
    ctx.fillStyle="#e7a7b8";
    ctx.fillRect(20, -12, 2, 2);

    ctx.fillStyle="#ff5aa5";
    ctx.fillRect(14, -16, 4, 4);
    ctx.fillRect(19, -16, 4, 4);
    ctx.fillRect(18, -15, 1, 1);

    ctx.fillStyle="#000";
    ctx.fillRect(14, -5, 2, 2);
    ctx.fillRect(22, -2, 2, 2);

    ctx.fillStyle="#caa1aa";
    ctx.fillRect(-18, -2, 8, 2);

    ctx.fillStyle="#8e8790";
    ctx.fillRect(-6, 6, 6, 3);
    ctx.fillRect(4,  6, 6, 3);

    ctx.restore();
  }

  function roundRect(x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    fill ? ctx.fill() : ctx.stroke();
  }

  function drawBubbleCentered(){
    const bx = 18;
    const bw = VW - 36;
    const by = 140;   // lower so title has space
    const bh = 62;

    if(sparkleTimer>0){
      sparkleTimer--;
      const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff","#8cff7a"];
      for(let i=0;i<26;i++){
        const x = bx + Math.random()*bw;
        const y = by + Math.random()*bh;
        ctx.fillStyle = colors[(Math.random()*colors.length)|0];
        ctx.fillRect(x + (Math.random()*18-9), y + (Math.random()*18-9), 2, 2);
      }
    }

    ctx.fillStyle="rgba(27,21,48,.58)";
    roundRect(bx,by,bw,bh,14,true);

    ctx.strokeStyle="rgba(255,255,255,.2)";
    ctx.lineWidth=2;
    roundRect(bx,by,bw,bh,14,false);

    ctx.fillStyle="#fff";
    ctx.font="12px 'Press Start 2P'";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(bubbleText, VW/2, by + bh/2);
  }

  // âœ… SAFE ARC TITLE (ALWAYS FITS)
  function drawArcLine(text, t, yBase, radius, fontPx){
    ctx.save();
    ctx.font = `${fontPx}px 'Press Start 2P'`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";

    const chars = text.split("");
    const total = chars.length;

    // tighter angles to keep inside screen
    const start = Math.PI*1.18;
    const end   = Math.PI*1.82;
    const step  = (end-start) / Math.max(1,total-1);

    for(let i=0;i<total;i++){
      const a = start + step*i;
      const wave = Math.sin(t/18 + i*0.7) * 2.2;

      const x = VW/2 + Math.cos(a)*radius;
      const y = yBase + Math.sin(a)*radius*0.55 + wave;

      // shadow
      ctx.save();
      ctx.translate(x+2,y+2);
      ctx.rotate(a+Math.PI/2);
      ctx.fillStyle="#000";
      ctx.fillText(chars[i],0,0);
      ctx.restore();

      // text
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(a+Math.PI/2);
      ctx.fillStyle="#ff4fa3";
      ctx.fillText(chars[i],0,0);
      ctx.restore();
    }
    ctx.restore();
  }

  // ===== Game state =====
  const flowers = [];
  let cheese = null;

  const rat = { x: 70, y: 520, dir: 1, speed: 2.8, target: null, busy:false };

  function dropCheese(gx,gy){
    if(gy < GROUND_Y+20) return;
    cheese = { x: gx-12, y: gy-16 };
    rat.target = { x: cheese.x, y: cheese.y };
    rat.busy = true;
    showBubble("Cheese spotted! ðŸ§€");
    chime();
  }

  function updateRat(){
    if(!rat.busy || !rat.target) return;
    const dx = rat.target.x - rat.x;
    const dy = rat.target.y - rat.y;
    const d = Math.hypot(dx,dy);
    rat.dir = dx >= 0 ? 1 : -1;

    if(d < 6){
      if(cheese){
        const colors=["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ff7aa5"];
        flowers.push({
          x: cheese.x - 6,
          y: cheese.y - 54,
          c: colors[(Math.random()*colors.length)|0]
        });
        cheese = null;

        showBubble(messages[msgIndex % messages.length]);
        msgIndex++;
        chime();
      }
      rat.busy = false;
      rat.target = null;
      return;
    }

    rat.x += (dx/d) * rat.speed;
    rat.y += (dy/d) * rat.speed;
    rat.x = Math.max(16, Math.min(VW-16, rat.x));
    rat.y = Math.max(GROUND_Y+30, Math.min(VH-70, rat.y));
  }

  // ===== Input =====
  canvas.addEventListener("pointerdown",(e)=>{
    safeResumeAudio();
    tryPlaySofia();
    const p = toGameCoords(e.clientX, e.clientY);
    dropCheese(p.x, p.y);
  });

  // ===== Render loop =====
  let t = 0;
  function draw(){
    t++;

    ctx.fillStyle="#000";
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

    ctx.save();
    ctx.translate(offX, offY);
    ctx.scale(scale, scale);

    // sky
    const sky = ctx.createLinearGradient(0,0,0,VH);
    sky.addColorStop(0,"#79b7ff");
    sky.addColorStop(1,"#bfe6ff");
    ctx.fillStyle = sky;
    ctx.fillRect(0,0,VW,VH);

    // moving clouds
    const cloudShift = (t*0.6) % (VW+140);
    drawCloud(30 + (cloudShift*0.55), 66);
    drawCloud(-90 + (cloudShift*0.85), 104);

    // ground
    ctx.fillStyle="#155f28";
    ctx.fillRect(0,GROUND_Y,VW,VH-GROUND_Y);
    ctx.fillStyle="rgba(0,0,0,.12)";
    for(let y=GROUND_Y; y<VH; y+=18) ctx.fillRect(0,y,VW,3);

    // confetti sparkles
    for(let i=0;i<70;i++){
      const x = (Math.random()*VW)|0;
      const y = (GROUND_Y+20 + Math.random()*(VH-GROUND_Y-80))|0;
      const c = ["#ff5aa5","#ffd24a","#7fd6ff","#b68cff","#ffffff"][i%5];
      ctx.fillStyle=c;
      ctx.fillRect(x,y,2,2);
    }

    // âœ… Title (2 lines) fully inside frame
    drawArcLine("Happy Valentineâ€™s Day", t, 54, 130, 14);
    drawArcLine("My bby ðŸ’—",            t, 86, 110, 14);

    // bubble
    if(bubbleTimer>0) bubbleTimer--;
    drawBubbleCentered();

    // objects
    flowers.forEach(f => drawFlower(f.x, f.y, f.c));
    if(cheese) drawCheese(cheese.x, cheese.y);

    updateRat();
    drawRat(Math.round(rat.x), Math.round(rat.y), rat.dir);

    // bottom signature inside frame
    ctx.fillStyle="rgba(0,0,0,.25)";
    ctx.fillRect(0, VH-48, VW, 48);

    ctx.fillStyle="#fff";
    ctx.font="14px 'Press Start 2P'";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(sigText, VW/2, VH-24);

    ctx.restore();
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>
